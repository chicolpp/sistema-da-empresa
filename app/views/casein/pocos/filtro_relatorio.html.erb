<!-- Scaffolding generated by Casein v5.1.0.0 -->

<div id="printableArea">
	<h2>
		Relatório de Poços
		<%= link_to("#{casein_show_icon "search"}Filtro Personalizado".html_safe, "#FiltroPersonalizado", "data-toggle" => "collapse", "aria-controls" => "false", "aria-expanded" => "false", "role" => "button", class: "pull-right") %>
	</h2>

	<div class="collapse" id="FiltroPersonalizado">
	  <div class="well">
	  	<%= form_tag(casein_poco_filtro_relatorio_path, method: :post, role: :form, id: "poco") do |f| %>
				<div class="row">
					<div class="col-xs-12 col-sm-6">
						<div class="form-group">
							<%= label_tag :cliente_id, "Cliente" %>
							<%= select_tag(:cliente_id, options_from_collection_for_select(Cliente.select("clientes.id, CONCAT(pessoas.nome, ' / ', cidades.nome, '-', estados.sigla, ' / ', IFNULL(pessoas_juridicas.cnpj, pessoas_fisicas.cpf)) as nome").joins(pessoa: [pessoa_endereco: [cidade: :estado]]).joins("LEFT JOIN pessoas_juridicas ON pessoas_juridicas.pessoa_id = pessoas.id LEFT JOIN pessoas_fisicas ON pessoas_fisicas.pessoa_id = pessoas.id").order("pessoas.nome ASC").all, 'id', 'nome', params[:cliente_id]), {:include_blank => "Mostrar Todos", class: "form-control select_padrao"}) %>
						</div>
					</div>
					<div class="col-xs-12 col-sm-2">
						<div class="form-group">
							<%= label_tag :perfuracao_leao, "Perfurado pela Materiáguas", class: "control-label" %>
							<%= select_tag :perfuracao_leao, options_for_select([["Sim", '1'], ["Não", '0']], params[:perfuracao_leao]), include_blank: "Mostrar Todos", class: "form-control select_padrao" %>
						</div>
					</div>
					<div class="col-xs-12 col-sm-2">
						<div class="form-group">
							<%= label_tag :poco_produtivo, "Poço Produtivo", class: "control-label" %>
							<%= select_tag :poco_produtivo, options_for_select([["Sim", '1'], ["Não", '0']], params[:poco_produtivo]), include_blank: "Mostrar Todos", class: "form-control select_padrao" %>
						</div>
					</div>
					<div class="col-xs-12 col-sm-2">
						<div class="form-group">
							<%= label_tag :tipo_manutencao, "Tipo de Manutenção", class: "control-label" %>
							<%= select_tag(:tipo_manutencao, options_from_collection_for_select(Servico.order("descricao ASC").all, 'id', 'descricao', params[:tipo_manutencao]), :include_blank => "Mostrar Todos", class: "form-control select_padrao") %>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-12 col-sm-3">
						<div class="form-group">
							<%= label_tag :profundidade_de, "Profundidade de", class: "control-label" %>
							<%= text_field_tag :profundidade_de, params[:profundidade_de], class: "form-control" %>
						</div>
			  	</div>
					<div class="col-xs-12 col-sm-3">
						<div class="form-group">
							<%= label_tag :profundidade_ate, "Profundidade até", class: "control-label" %>
							<%= text_field_tag :profundidade_ate, params[:profundidade_ate], class: "form-control" %>
						</div>
			  	</div>
					<div class="col-xs-12 col-sm-6">
						<div class="form-group">
							<%= label_tag :cidade_id, "Cidade/UF" %>
							<%= select_tag(:cidade_id, options_from_collection_for_select(Cidade.order("nome ASC").all, 'id', 'nome', params[:cidade_id]), :include_blank => "Mostrar Todas", class: "form-control select_padrao") %>
						</div>
					</div>
					<div class="col-xs-12 col-sm-2">
						<% params[:data] ||= {} %>
						<div class="form-group">
							<%= label_tag :data_data_inicial, "Data Inicial (Perfuração)" %>
							<%= text_field_tag 'data[data_inicial]', params[:data][:data_inicial], class: "form-control", data: {masker: true, type: :d} %>
			  		</div>
			  	</div>
					<div class="col-xs-12 col-sm-2">
						<div class="form-group">
							<%= label_tag :data_data_final, "Data Final (Perfuração)" %>
							<%= text_field_tag 'data[data_final]', params[:data][:data_final], class: "form-control", data: {masker: true, type: :d} %>
			  		</div>
			  	</div>
					<div class="col-xs-12 col-sm-2">
						<% params[:data_manutencao] ||= {} %>
						<div class="form-group">
							<%= label_tag :data_manutencao_data_inicial, "Data Inicial (Manutenção)" %>
							<%= text_field_tag 'data_manutencao[data_inicial]', params[:data_manutencao][:data_inicial], class: "form-control", data: {masker: true, type: :d} %>
			  		</div>
			  	</div>
					<div class="col-xs-12 col-sm-2">
						<div class="form-group">
							<%= label_tag :data_manutencao_data_final, "Data Final (Manutenção)" %>
							<%= text_field_tag 'data_manutencao[data_final]', params[:data_manutencao][:data_final], class: "form-control", data: {masker: true, type: :d} %>
			  		</div>
			  	</div>
					<div class="col-xs-12 col-sm-3">
						<div class="form-group">
							<%= label_tag :submit, "&nbsp;".html_safe, class: "control-label" %>
							<div class="form-group">
								<%= submit_tag "Filtrar", class: "btn btn-primary" %>
							</div>
						</div>
					</div>
				</div>
			<% end -%>
	  </div>
	</div>

	<%= form_tag(casein_poco_filtro_relatorio_path, method: :post, role: :form, class: "form-inline") do |f| %>
		<div class="row">
			<div class="col-xs-12" align="right" style="margin-bottom: 10px;">
				<div class="form-group">
					<%= label_tag :coringa, "Pesquisa Coringa" %>
					<%= text_field_tag :coringa, params[:coringa], class: "form-control input-sm tamanho-minimo-input" %>
	  		</div>
				<%= submit_tag "Filtrar", class: "btn btn-primary btn-sm" %>
			</div>
		</div>
	<% end -%>

	<table class="table table-striped table-bordered" cellspacing="0" width="100%" style="margin-top: 10px;">
		<thead>
			<tr>
				<th>Cliente</th>
				<th>Linha</th>
				<th>Poço</th>
				<th>Cidade</th>
        <% if current_user.is_admin? %>
					<th>Processo</th>
        <% end %>
				<th>Perf. Materiáguas</th>
				<th>Produtivo?</th>
				<th style="min-width: 80px;">&nbsp;</th>
			</tr>
		</thead>

		<tbody>
			<% @pocos.each do |poco| %>
				<tr>
					<td><%= poco.nome_poco %></td>
					<td><%= poco.linha_endereco %></td>
					<td><%= poco.apelido_endereco %></td>
					<td><%= poco.cidade.try(:get_nome_completo) %></td>
	        <% if current_user.is_admin? %>
						<td><%= poco.numero_processo %></td>
					<% end %>
					<td><%= poco.perfuracao_leao ? "Sim" : "Não" %></td>
					<td><%= poco.poco_produtivo ? "Sim" : "Não" %></td>
					<td style="min-width: 130px;">
						<%= link_to(casein_show_row_icon("print"), casein_poco_filtro_relatorio_path(:format => :pdf, id: poco.id), class: "icon-table pull-left", target: "_blank") %>
						<%= link_to casein_show_row_icon("zoom-in"), casein_poco_relatorio_detalhes_path(id: poco.id), class: "icon-table pull-left" %>
						<% if poco.coordenada.try(:latitude) %>
							<%= link_to casein_show_row_icon("road"), "https://www.google.com/maps/dir/#{ENV['GOOGLE_MAPS_ORIGIN']}/#{poco.coordenada.try(:latitude)},#{poco.coordenada.try(:longitude)}", class: "icon-table pull-left", target: :_blank %>
						<% end %>
						<% fotos = poco.arquivos.where("upload_content_type LIKE '%image%'") %>
						<% fotos1 = poco.instalacao.arquivos.where("upload_content_type LIKE '%image%'") if poco.instalacao.present? %>
						<% fotos2 = Foto.where(poco_id: poco.id) %>
						<% fotos3 = poco.vazao_agua.arquivos.where("upload_content_type LIKE '%image%'") if poco.vazao_agua.present? %>

						<% fotos4 = poco.perfuracao.arquivos.where("upload_content_type LIKE '%image%'") if poco.perfuracao.present? %>
						<% fotos5 = [] %>
						<% poco.aprofundamentos.map{|r| r.arquivos.map{|w| fotos5.push(w) if w.upload_content_type.include?('image/')}} if poco.aprofundamentos.present? %>
						<% fotos6 = [] %>
						<% poco.manutencaos.map{|r| r.arquivos.map{|w| fotos6.push(w) if w.upload_content_type.include?('image/')}} if poco.manutencaos.present? %>

						<% ja_exibiu_o_link = false %>

						<% if fotos.present? %>
							<% fotos.each_with_index do |foto, i| %>
								<%= link_to casein_show_row_icon("picture"), foto.upload.url, data: {lightbox: "galeria-de-fotos-#{poco.id}"}, class: "icon-table pull-left #{'hidden' if ja_exibiu_o_link}" %>
								<%- ja_exibiu_o_link = true -%>
							<% end %>
						<% end %>

						<% if fotos1.present? %>
							<% fotos1.each_with_index do |foto, i| %>
								<%= link_to casein_show_row_icon("picture"), foto.upload.url, data: {lightbox: "galeria-de-fotos-#{poco.id}"}, class: "icon-table pull-left #{'hidden' if ja_exibiu_o_link}" %>
								<%- ja_exibiu_o_link = true -%>
							<% end %>
						<% end %>

						<% if fotos2.present? %>
							<% fotos2.each_with_index do |foto, i| %>
								<%= link_to casein_show_row_icon("picture"), foto.foto.url, title: foto.observacao, data: {lightbox: "galeria-de-fotos-#{poco.id}"}, class: "icon-table pull-left #{'hidden' if ja_exibiu_o_link}" %>
								<%- ja_exibiu_o_link = true -%>
							<% end %>
						<% end %>

						<% if fotos3.present? %>
							<% fotos3.each_with_index do |foto, i| %>
								<%= link_to casein_show_row_icon("picture"), foto.upload.url, data: {lightbox: "galeria-de-fotos-#{poco.id}"}, class: "icon-table pull-left #{'hidden' if ja_exibiu_o_link}" %>
								<%- ja_exibiu_o_link = true -%>
							<% end %>
						<% end %>

						<% if fotos4.present? %>
							<% fotos4.each_with_index do |foto, i| %>
								<%= link_to casein_show_row_icon("picture"), foto.upload.url, data: {lightbox: "galeria-de-fotos-#{poco.id}"}, class: "icon-table pull-left #{'hidden' if ja_exibiu_o_link}" %>
								<%- ja_exibiu_o_link = true -%>
							<% end %>
						<% end %>

						<% if fotos5.present? %>
							<% fotos5.each_with_index do |foto, i| %>
								<%= link_to casein_show_row_icon("picture"), foto.upload.url, data: {lightbox: "galeria-de-fotos-#{poco.id}"}, class: "icon-table pull-left #{'hidden' if ja_exibiu_o_link}" %>
								<%- ja_exibiu_o_link = true -%>
							<% end %>
						<% end %>

						<% if fotos6.present? %>
							<% fotos6.each_with_index do |foto, i| %>
								<%= link_to casein_show_row_icon("picture"), foto.upload.url, data: {lightbox: "galeria-de-fotos-#{poco.id}"}, class: "icon-table pull-left #{'hidden' if ja_exibiu_o_link}" %>
								<%- ja_exibiu_o_link = true -%>
							<% end %>
						<% end %>
					</td>
				</tr>
			<% end %>
		</tbody>
	</table>
</div>

<%= will_paginate @pocos, previous_label: "Anterior", next_label: "Próxima", params: {coringa: params[:coringa]} %>